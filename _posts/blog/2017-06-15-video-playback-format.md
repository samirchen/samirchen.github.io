---
layout: post
title: 点播视频格式的选择
description: 介绍在点播中常用的视频格式。
category: blog
tag: Audio, Video, MP4
---


## 视频格式的基本介绍

这两年短视频成了内容创业的风口，各种短视频应用、短视频创作者异军突起，遍地开花，迅速成为各种 App 的重要甚至是主要的内容呈现形式。

短视频是一种点播形式的视频，点播视频的格式有挺多种的，比如：AVI、MKV、RM、FLV、MP4 等等，这些都是指的视频的封装格式。下面是对一些视频格式的介绍：


- **AVI 格式**，对应的文件格式为 `.avi`，英文全称 Audio Video Interleaved，是由 Microsoft 公司于 1992 年推出。这种视频格式的优点是图像质量好，无损 AVI 可以保存 alpha 通道。缺点是体积过于庞大，并且压缩标准不统一，存在较多的高低版本兼容问题。
- **DV-AVI 格式**，对应的文件格式为 `.avi`，英文全称 Digital Video Format，是由索尼、松下、JVC 等多家厂商联合提出的一种家用数字视频格式。常见的数码摄像机就是使用这种格式记录视频数据的。它可以通过电脑的 IEEE 1394 端口传输视频数据到电脑，也可以将电脑中编辑好的的视频数据回录到数码摄像机中。
- **WMV 格式**，对应的文件格式是 `.wmv`、`.asf`，英文全称 Windows Media Video，是微软推出的一种采用独立编码方式并且可以直接在网上实时观看视频节目的文件压缩格式。在同等视频质量下，WMV 格式的文件可以边下载边播放，因此很适合在网上播放和传输。
- **MPEG 格式**，对应的文件格式有 `.mpg`、`.mpeg`、`.mpe`、`.dat`、`.vob`、`.asf`、`.3gp`、`.mp4` 等等，英文全称 Moving Picture Experts Group，是由运动图像专家组制定的视频格式，该专家组于 1988 年组建，专门负责视频和音频标准制定，其成员都是视频、音频以及系统领域的技术专家。MPEG 格式目前有三个压缩标准，分别是 MPEG-1、MPEG-2、和 MPEG-4。MPEG-4 是现在用的比较多的视频封装格式，它为了播放流式媒体的高质量视频而专门设计的，以求使用最少的数据获得最佳的图像质量。
- **Matroska 格式**，对应的文件格式是 `.mkv`，Matroska 是一种新的视频封装格式，它可将多种不同编码的视频及 16 条以上不同格式的音频和不同语言的字幕流封装到一个 Matroska Media 文件当中。
- **Real Video 格式**，对应的文件格式是 `.rm`、`.rmvb`，是 Real Networks 公司所制定的音频视频压缩规范称为 Real Media。用户可以使用 RealPlayer 根据不同的网络传输速率制定出不同的压缩比率，从而实现在低速率的网络上进行影像数据实时传送和播放。
- **QuickTime File Format 格式**，对应的文件格式是 `.mov`，是 Apple 公司开发的一种视频格式，默认的播放器是苹果的 QuickTime。这种封装格式具有较高的压缩比率和较完美的视频清晰度等特点，并可以保存 alpha 通道。
- **Flash Video 格式**，对应的文件格式是 `.flv`，是由 Adobe Flash 延伸出来的一种网络视频封装格式。这种格式被很多视频网站所采用。


关于视频的一些基础概念可以看看这篇[关于视频的一些概念][3]。

在 PC Web 时代，由于 Flash 插件极高的覆盖率，FLV 是使用非常广泛的一种视频格式，被几乎所有的视频网站支持并作为主要的点播视频格式所使用。但是，随着 App 时代的到来以及 H5 的兴起，Flash 插件逐渐被抛弃，同时随着 H264 编码技术的普及、手机等硬件设备的升级，MP4 逐渐崛起成为了使用较为广泛的点播视频格式。

但是，MP4 也有个问题，它的文件格式比较复杂，所以处理成本较高，而且由于索引表复杂度高，所以通常当视频时长大于 5 分钟时，MP4 文件在线播放时加载速度会比较慢。所以，在长视频场景，通常还会使用苹果公司力推的 HLS 协议：

- **HLS**，是苹果公司实现的基于 HTTP 的流媒体传输协议，全称 HTTP Live Streaming，可支持流媒体的直播和点播，主要应用在 iOS 系统，为 iOS 设备（如 iPhone、iPad）提供音视频直播和点播方案。对于 HLS 点播，基本上就是常见的分段 HTTP 点播，不同在于，它的分段非常小。要实现HLS点播，重点在于对媒体文件分段。对于 HLS 直播，相对于常见的流媒体直播协议，例如 RTMP 协议、RTSP 协议等，HLS 最大的不同在于直播客户端获取到的并不是一个完整的数据流，而是连续的、短时长的媒体文件（MPEG-TS 格式），客户端不断的下载并播放这些小文件。由于数据通过 HTTP 协议传输，所以完全不用考虑防火墙或者代理的问题，而且分段文件的时长很短，客户端可以很快的选择和切换码率，以适应不同带宽条件下的播放。同时其精简的 M3U8 索引结构可以规避 MP4 索引慢的问题，在点播场景是非常不错的选择。不过 HLS 的这种技术特点，决定了它在直播场景的延迟一般总是会高于普通的流媒体直播协议。

但是，作为时长通常为一两分钟或者几十秒的短视频场景，MP4 仍然是一个不错的选择。


## MP4 的格式特点

如上文介绍，MP4 是现在用的比较多的视频封装格式，它为了播放流式媒体的高质量视频而专门设计的，以求使用最少的数据获得最佳的图像质量。但是它的文件格式复杂，索引慢，时长较长的 MP4 视频在线播放时加载较慢。那么它的格式到底有着怎样的特点呢？

无论是 AVI、FLV 还是 MP4 格式的文件，都会包含一个 metadata 的数据块，这里记录了当前文件的图像尺寸、编码格式、帧率、码率等信息。播放器在网络点播场景下去请求 MP4 视频数据，需要先获取到文件的 metadata 信息，解析出该文件的编码、帧率等信息后才能实现边下载数据，边送给解码器进行解码，最后通过渲染层将解码后的数据播放出来。

需要注意的是，我们有时候会遇到所请求的 MP4 短视频播放非常缓慢，这时候你就需要看看这个文件的 metadata 数据块是不是被编码在了 MP4 文件尾部，这种情况会导致播放器只有下载完整个文件后才能成功解析并播放这个视频。对于这种视频，我们最好能够在服务端将其重新编码，将 metadata 数据块转移到文件头部，保证播放器在线请求时能较快播放。比如 FFmpeg 的下列命令就可以支持这个操作：

```
ffmpeg -i bad.mp4 -movflags faststart good.mp4
```


此外，需要注意的是，在通过网络请求 MP4 视频文件进行边下载边播放时，由于接收到的每帧音视频数据是需要根据时间戳来决定何时送入解码器解码，以及何时显示，如果时间没到只能等待。尤其是当视频编码存在 B 帧时，解码时间戳 DTS 与显示时间戳顺序 PTS 通常不一致，这时候就会出现已经下载好的一帧数据可能还不能立即解码和显示，需要等待其依赖的数据下载完成和解码完成。这时在播放的过程中就可能因为网络抖动而出现播放卡顿。

关于音视频时间戳的概念，可以看一下[理解音视频 PTS 和 DTS][5]。









[SamirChen]: http://www.samirchen.com "SamirChen"
[1]: {{ page.url }} ({{ page.title }})
[2]: http://www.samirchen.com/video-playback-format
[3]: http://www.samirchen.com/video-concept/
[4]: http://www.360doc.com/content/13/0822/21/153944_309197656.shtml
[5]: http://www.samirchen.com/about-pts-dts/ 

